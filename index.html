<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Electricity Meter Tracker</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/meter-tracker/manifest.json" />
    <link rel="apple-touch-icon" href="/meter-tracker/icon.svg" />

    <!-- Meta -->
    <meta name="theme-color" content="#0073e6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="description" content="Track your dual electricity meters and manage 200-unit monthly limit." />

    <!-- React (Production - Critical Fix) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '475px',
                    }
                }
            }
        }
    </script>

    <!-- Inline Styles -->
    <style>
        body {
            overscroll-behavior: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        button, input, select {
            min-height: 44px;
            touch-action: manipulation;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .meter-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .meter-card:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/meter-tracker/sw.js')
                    .then(reg => console.log('✅ SW registered:', reg.scope))
                    .catch(err => console.error('❌ SW registration failed:', err));
            });
        }
    </script>

    <!-- Main App -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        const icons = {
            Zap: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('polygon', { points: '13 2 3 14 12 14 11 22 21 10 12 10 13 2' })
            ),
            Plus: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('path', { d: 'm12 5v14' }),
                React.createElement('path', { d: 'm5 12h14' })
            ),
            Edit: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('path', { d: 'M7 7H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-1' }),
                React.createElement('path', { d: 'M20.385 6.585a2.1 2.1 0 0 0-2.97-2.97L9 12v3h3l8.385-8.415Z' })
            ),
            Trash2: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('path', { d: 'm3 6h18' }),
                React.createElement('path', { d: 'M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6' }),
                React.createElement('path', { d: 'M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2' })
            ),
            BarChart3: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('path', { d: 'M3 3v18h18' }),
                React.createElement('path', { d: 'M18 17V9' }),
                React.createElement('path', { d: 'M13 17V5' }),
                React.createElement('path', { d: 'M8 17v-3' })
            ),
            Download: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
                React.createElement('polyline', { points: '7,10 12,15 17,10' }),
                React.createElement('line', { x1: 12, y1: 15, x2: 12, y2: 3 })
            ),
            AlertTriangle: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('path', { d: 'm21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z' }),
                React.createElement('path', { d: 'm12 9v4' }),
                React.createElement('path', { d: 'm12 17h.01' })
            ),
            CheckCircle: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('path', { d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' }),
                React.createElement('polyline', { points: '22,4 12,14.01 9,11.01' })
            ),
            ArrowLeft: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('path', { d: 'm12 19-7-7 7-7' }),
                React.createElement('path', { d: 'M19 12H5' })
            )
        };

        const ElectricityMeterTracker = () => {
            const [meters, setMeters] = useState([]);
            const [readings, setReadings] = useState([]);
            const [monthlyRecords, setMonthlyRecords] = useState([]);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedMeter, setSelectedMeter] = useState(null);
            const [editingMeter, setEditingMeter] = useState(null);
            const [newMeter, setNewMeter] = useState({
                meterNumber: '',
                nickname: '',
                type: 'single-phase',
                baseReading: ''
            });
            const [newReading, setNewReading] = useState({
                date: new Date().toISOString().split('T')[0],
                reading: '',
                endOfCycle: false
            });

            const saveToStorage = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error(`Error saving ${key}:`, e);
                }
            };

            const loadFromStorage = (key, defaultValue = []) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error(`Error loading ${key}:`, e);
                    return defaultValue;
                }
            };

            useEffect(() => {
                const storedMeters = loadFromStorage('meters');
                const storedReadings = loadFromStorage('readings');
                const storedMonthly = loadFromStorage('monthlyRecords');

                if (storedMeters.length === 0 && storedReadings.length === 0) {
                    const sampleMeters = [
                        { id: 1, meterNumber: 'MT001', nickname: 'Main Meter', type: 'single-phase', baseReading: 1000, currentReading: 1150 },
                        { id: 2, meterNumber: 'MT002', nickname: 'Backup Meter', type: 'three-phase', baseReading: 500, currentReading: 580 }
                    ];
                    const sampleReadings = [
                        { id: 1, meterId: 1, date: '2025-09-01', reading: 1100 },
                        { id: 2, meterId: 1, date: '2025-09-02', reading: 1150 },
                        { id: 3, meterId: 2, date: '2025-09-01', reading: 550 },
                        { id: 4, meterId: 2, date: '2025-09-02', reading: 580 }
                    ];
                    setMeters(sampleMeters);
                    setReadings(sampleReadings);
                    setMonthlyRecords([]);
                    saveToStorage('meters', sampleMeters);
                    saveToStorage('readings', sampleReadings);
                    saveToStorage('monthlyRecords', []);
                } else {
                    setMeters(storedMeters);
                    setReadings(storedReadings);
                    setMonthlyRecords(storedMonthly);
                }
            }, []);

            useEffect(() => meters.length > 0 && saveToStorage('meters', meters), [meters]);
            useEffect(() => readings.length > 0 && saveToStorage('readings', readings), [readings]);
            useEffect(() => monthlyRecords.length > 0 && saveToStorage('monthlyRecords', monthlyRecords), [monthlyRecords]);

            const addMeter = () => {
                if (!newMeter.meterNumber || !newMeter.nickname || !newMeter.baseReading) {
                    alert('Please fill all fields');
                    return;
                }
                const meter = {
                    id: Date.now(),
                    ...newMeter,
                    baseReading: parseFloat(newMeter.baseReading),
                    currentReading: parseFloat(newMeter.baseReading)
                };
                setMeters(prev => [...prev, meter]);
                setNewMeter({ meterNumber: '', nickname: '', type: 'single-phase', baseReading: '' });
                setCurrentView('dashboard');
            };

            const updateMeter = () => {
                if (!editingMeter.meterNumber || !editingMeter.nickname || !editingMeter.baseReading) {
                    alert('Please fill all fields');
                    return;
                }
                setMeters(prev => prev.map(m => m.id === editingMeter.id ? editingMeter : m));
                setEditingMeter(null);
                setCurrentView('dashboard');
            };

            const deleteMeter = (id) => {
                if (window.confirm('Delete this meter and all readings?')) {
                    setMeters(prev => prev.filter(m => m.id !== id));
                    setReadings(prev => prev.filter(r => r.meterId !== id));
                }
            };

            const getCurrentUsage = (meterId) => {
                const meter = meters.find(m => m.id === meterId);
                return meter ? Math.max(0, meter.currentReading - meter.baseReading) : 0;
            };

            const getTotalUsage = () => {
                return meters.reduce((sum, m) => sum + getCurrentUsage(m.id), 0);
            };

            const addReading = () => {
                const reading = parseFloat(newReading.reading);
                const meter = meters.find(m => m.id === selectedMeter.id);
                const lastReading = [...readings]
                    .filter(r => r.meterId === selectedMeter.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                const previous = lastReading ? lastReading.reading : meter?.baseReading || 0;

                if (reading <= previous) {
                    alert('Reading must be greater than previous value.');
                    return;
                }

                const record = {
                    id: Date.now(),
                    meterId: selectedMeter.id,
                    date: newReading.date,
                    reading,
                    endOfCycle: newReading.endOfCycle
                };

                setReadings(prev => [...prev, record]);
                setMeters(prev => prev.map(m => m.id === selectedMeter.id ? { ...m, currentReading: reading } : m));

                if (newReading.endOfCycle) {
                    const usage = meters.reduce((sum, m) => sum + (m.currentReading - m.baseReading), 0);
                    const month = new Date().toISOString().slice(0, 7);
                    const record = {
                        id: Date.now(),
                        month,
                        totalUsage: Math.max(0, usage),
                        meters: meters.map(m => ({ meterId: m.id, usage: Math.max(0, m.currentReading - m.baseReading) }))
                    };
                    setMonthlyRecords(prev => [...prev, record]);
                    setMeters(prev => prev.map(m => ({ ...m, baseReading: m.currentReading })));
                }

                setNewReading({ date: new Date().toISOString().split('T')[0], reading: '', endOfCycle: false });
                setCurrentView('dashboard');
            };

            const exportToCSV = () => {
                const csvData = readings.map(r => {
                    const meter = meters.find(m => m.id === r.meterId);
                    return [
                        r.date,
                        meter?.meterNumber || '',
                        meter?.nickname || '',
                        r.reading,
                        r.endOfCycle ? 'Yes' : 'No'
                    ].join(',');
                });
                const csv = ['Date,Meter Number,Nickname,Reading,End of Cycle', ...csvData].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'meter-readings.csv';
                a.click();
                setTimeout(() => URL.revokeObjectURL(url), 100);
                alert('Exported successfully!');
            };

            const totalUsage = getTotalUsage();
            const usagePercent = Math.min(100, (totalUsage / 200) * 100);

            if (currentView === 'dashboard') {
                return (
                    <div className="min-h-screen pb-20">
                        <header className="bg-white shadow-sm sticky top-0 z-40 px-4 py-4">
                            <div className="flex justify-between items-center">
                                <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <icons.Zap /> Meter Tracker
                                </h1>
                                <div className="flex gap-2">
                                    <button onClick={() => setCurrentView('reports')} className="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">
                                        <icons.BarChart3 />
                                    </button>
                                    <button onClick={exportToCSV} className="p-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200">
                                        <icons.Download />
                                    </button>
                                </div>
                            </div>
                        </header>

                        <main className="px-4 pt-4">
                            <section className="bg-blue-50 p-4 rounded-lg mb-6">
                                <h3 className="font-semibold text-blue-800 mb-2">Current Month Usage</h3>
                                <p className="text-2xl font-bold text-blue-600">{totalUsage.toFixed(1)} / 200 units</p>
                                <div className="w-full bg-blue-200 rounded-full h-3 mt-2">
                                    <div className={`h-3 rounded-full bg-blue-600`} style={{ width: `${usagePercent}%` }}></div>
                                </div>
                                <p className="text-sm text-blue-700 mt-1">{(200 - totalUsage).toFixed(1)} units remaining</p>
                            </section>

                            <div className="grid gap-4">
                                {meters.map(meter => (
                                    <div key={meter.id} className="bg-white rounded-lg shadow-lg p-4 meter-card">
                                        <div className="flex justify-between mb-4">
                                            <div>
                                                <h3 className="font-bold text-lg">{meter.nickname}</h3>
                                                <p className="text-sm text-gray-600">#{meter.meterNumber}</p>
                                                <span className={`text-xs px-2 py-1 rounded mt-1 ${meter.type === 'single-phase' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>
                                                    {meter.type}
                                                </span>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => { setEditingMeter(meter); setCurrentView('editMeter'); }} className="p-2 text-gray-500 hover:text-blue-600"><icons.Edit /></button>
                                                <button onClick={() => deleteMeter(meter.id)} className="p-2 text-gray-500 hover:text-red-600"><icons.Trash2 /></button>
                                            </div>
                                        </div>
                                        <div className="space-y-2 mb-4">
                                            <div className="flex justify-between"><span className="text-sm text-gray-600">Current Reading:</span><span>{meter.currentReading}</span></div>
                                            <div className="flex justify-between"><span className="text-sm text-gray-600">Usage:</span><span className="text-blue-600 font-semibold">{getCurrentUsage(meter.id).toFixed(1)} units</span></div>
                                        </div>
                                        <button onClick={() => { setSelectedMeter(meter); setCurrentView('addReading'); }} className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium">Add Reading</button>
                                    </div>
                                ))}

                                <div className="bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 flex items-center justify-center">
                                    <button onClick={() => setCurrentView('addMeter')} className="flex flex-col items-center gap-2 text-gray-500 hover:text-blue-600">
                                        <icons.Plus className="w-8 h-8" /> <span className="font-semibold">Add New Meter</span>
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            // Add other views (addMeter, editMeter, addReading, reports) here later
            return <div className="p-4 text-center">Other views coming soon</div>;
        };

        ReactDOM.render(<ElectricityMeterTracker />, document.getElementById('root'));
    </script>
</body>
</html>